# D4 Code Base


## Overview

In general, packages under [org.opendata.core](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/core) contain basic concepts, packages under [opendata.org.db](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/db) contain classes that are primarily needed for data preparation and accessing terms, equivalence classes, and columns, and the packages under [org.opendata.curation.d4](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/curation/d4) contain classes that implement the different parts of the **D4** algorithm.


## D4 Workflow Steps

The main class is [org.opendata.curation.d4.D4](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/D4.java). It contains the workflow and references to the classes that implement the different D4 steps. The [DataManager](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/DataManager.java) is intended as a *factory* for all the input data and objects (e.g., the term similarity function and the signature robustifier) that are used by the algorithm.

The **D4** algorithm has four main steps, signature generation, column expansion, local domain discovery and strong domain generation. Packages under [org.opendata.curation.d4.signature](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/curation/d4/signature) contain classes that are used to generate and robustify signatures. The packages under [org.opendata.curation.d4.column](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/curation/d4/column) implement the column expansion step. Local domain discovery and strong domain generation is implemented by the packages under [org.opendata.curation.d4.domain](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/curation/d4/domain).


## Robust Context Signatures

*Robust signatures* are generated using the [SignatureBlocksGenerator](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/SignatureBlocksGenerator.java). The private class [BlockGeneratorTask](https://github.com/VIDA-NYU/domain-discovery-d4/blob/7505ba7f3b9378b71294d65cc6a4a79ea4ec5bd8/src/main/java/org/opendata/curation/d4/signature/SignatureBlocksGenerator.java#L49) is the worker for different threads that compute the signatures. The [ContextSignatureGenerator](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/ContextSignatureGenerator.java) computes the context signatures and the [MaxDropFinder](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/core/prune/MaxDropFinder.java) is used to compute the steepest drops in context signatures. There are several different similarity functions in the package [org.opendata.db.eq.similarity](https://github.com/VIDA-NYU/domain-discovery-d4/tree/master/src/main/java/org/opendata/db/eq/similarity) that one can use. We mainly settled on [JISimilarity](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/db/eq/similarity/JISimilarity.java) for now.

Note that we do not keep context signatures in memory due to the size of the data. Instead, the generated context signatures are directly passed on to a [ContextSignatureProcessor](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/ContextSignatureProcessor.java) that divides the signature into blocks (using the [MaxDropFinder](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/core/prune/MaxDropFinder.java)) and passes the result to a [SignatureRobustifier](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/trim/SignatureRobustifier.java) that is used to prune signature blocks, e.g., the [LiberalRobustifier](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/trim/LiberalRobustifier.java) removes all blocks starting from the largest block and the [IgnoreLastBlockRobustifier](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/trim/IgnoreLastBlockRobustifier.java) removes only the last block (intended for use in combination with the ignore minor drop setting). The robustifier passes the pruned signature blocks onto a [ContextSignatureBlocksConsumer](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/ContextSignatureBlocksConsumer.java), e.g., the [ContextSignatureBlocksWriter](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/ContextSignatureBlocksWriter.java) to materialize signatures on disk or the [ContextSignatureBlocksIndex](https://github.com/VIDA-NYU/domain-discovery-d4/blob/master/src/main/java/org/opendata/curation/d4/signature/ContextSignatureBlocksIndex.java) if one wants to keep all signatures in memory.
